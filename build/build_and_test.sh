#!/bin/bash
set -e

source /etc/profile.d/rvm.sh

#Build and copy React assets
rm -rf $RAILS_PATH/public/assets/js/*
rm -rf $RAILS_PATH/public/assets/css/*

cd $REACT_PATH
yarn install

REACT_APP_EXPANDED_SEARCH_ORGANISATION_TAB=true REACT_APP_EXPANDED_SEARCH_PEOPLE_TAB=true REACT_APP_FEATURE_ILLUSTRATIONS=true REACT_APP_GA_PROPERTY_ID=$GA_PROPERTY_ID REACT_APP_FEATURE_OFFLINE=true REACT_APP_API_URL=$HOST_IP/api/v1 yarn build

cp -r $REACT_PATH/build/assets $RAILS_PATH/public
cp $REACT_PATH/build/*.js $RAILS_PATH/public/
cp $REACT_PATH/build/*.json $RAILS_PATH/public/
cp $REACT_PATH/build/*.png $RAILS_PATH/public/
cp $REACT_PATH/build/index.html $RAILS_PATH/public/
cp $REACT_PATH/build/index.html $RAILS_PATH/app/views/react/

REACT_APP_EXPANDED_SEARCH_ORGANISATION_TAB=true REACT_APP_EXPANDED_SEARCH_PEOPLE_TAB=true REACT_APP_FEATURE_ILLUSTRATIONS=true REACT_APP_FEATURE_OFFLINE=true REACT_APP_API_URL=$HOST_IP/api/v1 yarn build-bookends

cp -r $REACT_PATH/build/assets $RAILS_PATH/public


cd $RAILS_PATH
chmod 777 $RAILS_PATH/lib/scripts/add_react_version.sh

RAILS_ROOT=$RAILS_PATH SW_BUILD_DIR=$REACT_PATH/build $RAILS_PATH/lib/scripts/add_react_version.sh

npm install smartcrop-gm

mkdir -p tmp

# rm -rf $REACT_PATH
# rm -rf $RAILS_PATH/pkg/*

cp /config_files/application.rb $RAILS_PATH/config/application.rb
cp /config_files/database.yml $RAILS_PATH/config/database.yml
cp /config_files/fog.yml $RAILS_PATH/config/fog.yml
cp /config_files/production.rb $RAILS_PATH/config/environments/production.rb
cp /config_files/production.yml $RAILS_PATH/config/settings/production.yml
cp /config_files/puma.rb $RAILS_PATH/config/puma.rb
cp /config_files/session_store.rb $RAILS_PATH/config/initializers/session_store.rb
cp /config_files/elasticsearch.yml $RAILS_PATH/config/elasticsearch.yml
cp /config_files/newrelic.yml $RAILS_PATH/config/newrelic.yml
cp /config_files/devise.rb $RAILS_PATH/config/initializers/newrelic.yml
bundle install

FACEBOOK_AUTH=True RAILS_ENV=production rootUrl=$HOST_IP NEWRELIC_API_KEY=$NEWRELIC_API_KEY NEWRELIC_NAME=$NEWRELIC_NAME MAILER_USER=$MAILER_USER MAILER_PASSWORD=$MAILER_PASSWORD MAILER_DOMAIN=$MAILER_DOMAIN FACEBOOK_APP_ID=$FACEBOOK_APP_ID FACEBOOK_SECRET_KEY=$FACEBOOK_SECRET_KEY GOOGLE_SIGNIN_APP_ID=$GOOGLE_SIGNIN_APP_ID GOOGLE_SECRET_KEY=$GOOGLE_SECRET_KEY GA_PROPERTY_ID=$GA_PROPERTY_ID GOOGLE_APP_ID=$GOOGLE_TRANSLATE_APP_ID MAILCHIMP_LIST_ID=$MAILCHIMP_LIST_ID MAILCHIMP_API_KEY=$MAILCHIMP_API_KEY DEVISE_SECRET_KEY_BASE=$DEVISE_SECRET_KEY_BASE SECRET_KEY_BASE=$SECRET_KEY_BASE GOOGLE_STORAGE_ACCESS_KEY_ID=$GOOGLE_STORAGE_ACCESS_KEY_ID GOOGLE_STORAGE_SECRET_ACCESS_KEY=$GOOGLE_STORAGE_SECRET_ACCESS_KEY COUCHBASE_IP=$COUCHBASE_IP ELASTICSEARCH_URL=$ELASTICSEARCH_IP bundle exec rake assets:precompile

FACEBOOK_AUTH=True RAILS_ENV=production rootUrl=$HOST_IP NEWRELIC_API_KEY=$NEWRELIC_API_KEY NEWRELIC_NAME=$NEWRELIC_NAME MAILER_USER=$MAILER_USER MAILER_PASSWORD=$MAILER_PASSWORD MAILER_DOMAIN=$MAILER_DOMAIN FACEBOOK_APP_ID=$FACEBOOK_APP_ID FACEBOOK_SECRET_KEY=$FACEBOOK_SECRET_KEY GOOGLE_SIGNIN_APP_ID=$GOOGLE_SIGNIN_APP_ID GOOGLE_SECRET_KEY=$GOOGLE_SECRET_KEY GA_PROPERTY_ID=$GA_PROPERTY_ID GOOGLE_APP_ID=$GOOGLE_TRANSLATE_APP_ID MAILCHIMP_LIST_ID=$MAILCHIMP_LIST_ID MAILCHIMP_API_KEY=$MAILCHIMP_API_KEY DEVISE_SECRET_KEY_BASE=$DEVISE_SECRET_KEY_BASE SECRET_KEY_BASE=$SECRET_KEY_BASE GOOGLE_STORAGE_ACCESS_KEY_ID=$GOOGLE_STORAGE_ACCESS_KEY_ID GOOGLE_STORAGE_SECRET_ACCESS_KEY=$GOOGLE_STORAGE_SECRET_ACCESS_KEY COUCHBASE_IP=$COUCHBASE_IP ELASTICSEARCH_URL=$ELASTICSEARCH_IP bundle pack

FACEBOOK_AUTH=True RAILS_ENV=production rootUrl=$HOST_IP NEWRELIC_API_KEY=$NEWRELIC_API_KEY NEWRELIC_NAME=$NEWRELIC_NAME MAILER_USER=$MAILER_USER MAILER_PASSWORD=$MAILER_PASSWORD MAILER_DOMAIN=$MAILER_DOMAIN FACEBOOK_APP_ID=$FACEBOOK_APP_ID FACEBOOK_SECRET_KEY=$FACEBOOK_SECRET_KEY GOOGLE_SIGNIN_APP_ID=$GOOGLE_SIGNIN_APP_ID GOOGLE_SECRET_KEY=$GOOGLE_SECRET_KEY GA_PROPERTY_ID=$GA_PROPERTY_ID GOOGLE_APP_ID=$GOOGLE_TRANSLATE_APP_ID MAILCHIMP_LIST_ID=$MAILCHIMP_LIST_ID MAILCHIMP_API_KEY=$MAILCHIMP_API_KEY DEVISE_SECRET_KEY_BASE=$DEVISE_SECRET_KEY_BASE SECRET_KEY_BASE=$SECRET_KEY_BASE GOOGLE_STORAGE_ACCESS_KEY_ID=$GOOGLE_STORAGE_ACCESS_KEY_ID GOOGLE_STORAGE_SECRET_ACCESS_KEY=$GOOGLE_STORAGE_SECRET_ACCESS_KEY COUCHBASE_IP=$COUCHBASE_IP ELASTICSEARCH_URL=$ELASTICSEARCH_IP bundle exec rake repackage
